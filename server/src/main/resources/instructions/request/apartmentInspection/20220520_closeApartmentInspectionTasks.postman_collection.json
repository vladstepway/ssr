{
	"info": {
		"_postman_id": "730f8058-ffde-411c-9f24-64c389a45378",
		"name": "closeApartmentInspectionTasks",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "close tasks",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"let taskIds = pm.collectionVariables.get(\"taskIds\");",
							"",
							"if(!taskIds || taskIds.length == 0) {",
							"    pm.collectionVariables.set(\"cookie\", \"\");",
							"    pm.collectionVariables.set(\"urlHost\", \"smart.mos.ru\");",
							"    taskIds = [\"7093645:2022-06-12\", \"7093486:2022-06-12\", \"7089796:2022-06-15\", \"7089590:2022-06-15\", \"7089723:2022-06-15\", \"7090151:2022-05-26\", \"7103535:2022-06-01\", \"7094398:2022-06-11\", \"7102957:2022-06-20\", \"7102820:2022-06-10\", \"7093859:2022-05-28\", \"7090642:2022-06-17\", \"7094562:2022-05-25\", \"7094458:2022-05-26\", \"7090693:2022-06-04\", \"7090214:2022-05-28\", \"7089960:2022-05-27\", \"7088161:2022-05-26\", \"7086384:2022-05-25\", \"7113043:2022-05-26\", \"7093071:2022-06-14\", \"7088963:2022-05-24\", \"7091683:2022-06-14\", \"7069998:2022-06-30\", \"7092582:2022-06-12\", \"7093263:2022-06-12\", \"7092929:2022-06-12\", \"7110387:2022-05-17\", \"7111111:2022-05-27\", \"7112054:2022-05-26\", \"7112139:2022-05-18\", \"7113459:2022-05-27\", \"7112209:2022-05-18\", \"7112334:2022-05-18\", \"7112397:2022-05-18\", \"7112465:2022-05-18\", \"7112619:2022-05-26\", \"7112670:2022-05-19\", \"7112730:2022-05-26\", \"7112825:2022-06-12\", \"7112902:2022-05-26\", \"7112959:2022-05-26\", \"7113354:2022-05-27\", \"7113405:2022-06-13\", \"7113634:2022-05-27\", \"7120760:2022-05-30\", \"7125285:2022-06-15\", \"7125420:2022-06-15\", \"7126066:2022-06-15\", \"7126167:2022-06-15\", \"7128469:2022-06-15\", \"7126588:2022-05-30\", \"7128801:2022-05-30\", \"7125369:2022-06-15\", \"7117808:2022-05-30\", \"7126218:2022-06-15\", \"7114295:2022-06-17\", \"7115692:2022-05-30\", \"7115950:2022-06-16\", \"7122171:2022-06-15\", \"7128160:2022-06-15\", \"7114005:2022-06-16\", \"7125471:2022-06-15\", \"7126375:2022-06-30\", \"7126269:2022-06-16\", \"7121902:2022-06-13\", \"7110745:2022-05-27\", \"7126437:2022-06-16\", \"7120291:2022-06-30\", \"7119688:2022-05-30\", \"7125770:2022-06-16\", \"7113106:2022-05-27\", \"7113230:2022-05-27\", \"7137172:2022-05-30\", \"7137438:2022-06-01\", \"7125937:2022-06-15\", \"7137815:2022-05-30\", \"7139384:2022-05-31\", \"7139435:2022-06-30\", \"7139939:2022-06-20\", \"7127461:2022-06-17\", \"7127523:2022-06-16\", \"7142247:2022-06-20\", \"7137680:2022-06-30\", \"7138621:2022-06-20\", \"7127614:2022-06-17\", \"7127370:2022-06-17\", \"7144946:2022-06-15\", \"7145337:2022-06-15\", \"7147238:2022-05-23\", \"7143753:2022-06-15\", \"7146894:2022-05-23\", \"7147861:2022-06-20\", \"7147144:2022-06-17\", \"7147946:2022-06-20\", \"7136902:2022-05-20\", \"7148008:2022-06-20\", \"7148059:2022-06-20\", \"7138931:2022-05-31\", \"7148841:2022-06-17\", \"7148892:2022-06-27\", \"7148454:2022-05-27\", \"7148954:2022-06-20\", \"7148522:2022-05-27\", \"7201485:2022-06-18\", \"7201384:2022-05-31\", \"7202382:2022-06-20\", \"7202864:2022-06-17\", \"7203811:2022-06-17\", \"7203993:2022-06-01\", \"7197251:2022-05-23\", \"7142359:2022-06-17\", \"7205605:2022-06-15\", \"7206275:2022-06-18\", \"7205973:2022-06-18\", \"7207143:2022-06-16\", \"7207518:2022-06-16\", \"7093020:2022-06-14\", \"7122330:2022-06-15\", \"7208603:2022-06-18\", \"7208450:2022-06-17\", \"7208722:2022-06-18\", \"7090883:2022-06-17\", \"7209213:2022-05-25\", \"7211642:2022-06-01\", \"7211591:2022-06-18\", \"7211711:2022-06-18\", \"7045410:2022-05-27\", \"7045359:2022-05-18\", \"7219566:2022-05-23\", \"7207800:2022-06-17\", \"7209162:2022-06-21\", \"7208111:2022-06-20\", \"7207651:2022-06-16\", \"7204985:2022-06-20\", \"7206590:2022-06-16\", \"7204244:2022-06-01\", \"7202260:2022-06-20\", \"7202054:2022-06-20\", \"7201975:2022-06-20\", \"7207953:2022-06-17\", \"7207393:2022-06-16\", \"7206719:2022-06-16\", \"7205861:2022-06-15\", \"7205050:2022-06-15\", \"7204321:2022-06-15\", \"7203898:2022-06-15\", \"7210799:2022-06-18\", \"7210605:2022-06-18\", \"7210986:2022-06-18\", \"7211897:2022-06-15\", \"7112568:2022-06-13\", \"7081259:2022-06-23\", \"7212010:2022-05-30\", \"7234497:2022-06-15\", \"7235300:2022-06-18\", \"7235459:2022-06-18\", \"7088013:2022-05-25\", \"7088329:2022-05-26\", \"7090405:2022-06-13\", \"7090516:2022-05-28\", \"7091104:2022-06-06\", \"7091155:2022-06-04\", \"7091326:2022-06-30\", \"7091798:2022-06-04\", \"7091865:2022-06-12\", \"7092370:2022-06-06\", \"7092466:2022-06-06\", \"7092827:2022-06-14\", \"7093173:2022-06-11\", \"7093318:2022-05-27\", \"7093541:2022-06-13\", \"7093696:2022-05-27\", \"7093910:2022-06-06\", \"7094075:2022-06-06\", \"7094295:2022-05-27\", \"7094164:2022-06-06\", \"7094244:2022-06-07\", \"7094617:2022-06-13\", \"7094877:2022-06-13\", \"7095302:2022-06-13\", \"7095773:2022-06-23\", \"7095835:2022-06-14\", \"7045257:2022-06-11\", \"7103019:2022-06-01\"];",
							"}",
							"",
							"let currentInfo = taskIds.shift().split(\":\");",
							"let currentTaskId = currentInfo[0];",
							"let currentDelayReason = currentInfo[1];",
							"let currentDelayReasonDate = new Date(currentDelayReason);",
							"currentDelayReasonDate.setHours(0,0,0,0);",
							"let oneDay = 24 * 60 * 60 * 1000;",
							"let currentDate = new Date();",
							"currentDate.setHours(0,0,0,0);",
							"console.log(currentDelayReasonDate);",
							"let daysBetween = Math.round((currentDelayReasonDate - currentDate) / oneDay) - 1;",
							"daysToNotificationForActivity = (daysBetween < 0) ? \"P0D\" : \"P\" + daysBetween + \"D\";",
							"",
							"pm.collectionVariables.set(\"taskIds\", taskIds);",
							"pm.collectionVariables.set(\"currentTaskId\", currentTaskId);",
							"pm.collectionVariables.set(\"daysToNotificationForActivity\", daysToNotificationForActivity);",
							"",
							"console.log(\"close task: currentTaskId = \" + currentTaskId + \", delayReasonDate = \" + currentDelayReasonDate + \", daysToNotificationForActivity = \" + daysToNotificationForActivity + \", daysBetween = \" + daysBetween);",
							""
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"let taskIds = pm.collectionVariables.get(\"taskIds\");",
							"if (taskIds && taskIds.length > 0) {",
							"    postman.setNextRequest(\"close tasks\");",
							"}",
							"",
							"pm.test(\"Status code is 204\", function () {",
							"    pm.response.to.have.status(204);",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Cookie",
						"value": "{{cookie}}",
						"type": "default"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"taskId\": {{currentTaskId}},\n    \"properties\": [\n        {\n            \"id\": \"NotificationPeriodVar\",\n            \"value\": \"{{daysToNotificationForActivity}}\"\n        },\n        {\n            \"id\": \"AreDefectsEliminated\",\n            \"value\": \"false\"\n        }\n    ]\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "https://{{urlHost}}/app/ugd/bpm/form/form-data",
					"protocol": "https",
					"host": [
						"{{urlHost}}"
					],
					"path": [
						"app",
						"ugd",
						"bpm",
						"form",
						"form-data"
					]
				}
			},
			"response": []
		}
	],
	"variable": [
		{
			"key": "cookie",
			"value": ""
		},
		{
			"key": "urlHost",
			"value": ""
		},
		{
			"key": "taskIds",
			"value": ""
		},
		{
			"key": "currentTaskId",
			"value": ""
		},
		{
			"key": "delayReasonDates",
			"value": ""
		},
		{
			"key": "daysToNotificationForActivity",
			"value": ""
		}
	]
}
